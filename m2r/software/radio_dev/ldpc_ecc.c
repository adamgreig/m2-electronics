#include "ldpc_ecc.h"
#include <stdlib.h>
#include <string.h>

/* Defined at the bottom of the file to keep it out of the way.
 * Generated by ldpc.py based on design matrix from CCSDS 231.1-O-1.
 */
static const uint32_t ldpc_256_128_parity[128][4];

/* Counts number of set bits in a uint32_t.
 * Gross hack courtesy of the always amusing
 * http://graphics.stanford.edu/~seander/bithacks.html
 */
static uint32_t popcount(uint32_t v) {
     v = v - ((v >> 1) & 0x55555555);
     v = (v & 0x33333333) + ((v >> 2) & 0x33333333);
     return (((v + (v >> 4)) & 0x0F0F0F0F) * 0x01010101) >> 24;
}

/* Encode 16 bytes of `data` to 32 bytes of `coded`. */
void ldpc_encode(uint8_t* data, uint8_t* coded)
{
    int i, j;
    uint32_t *data_32 = (uint32_t*)data;

    /* Code is systematic so first 16 bytes are identical. */
    memcpy(coded, data, 16);
    /* Set all parity bits to 0 to initialise. */
    memset(coded+16, 0, 16);

    /* Now generate each of 128 parity bits. */
    for(i=0; i<128; i++) {
        uint32_t count = 0;
        for(j=0; j<4; j++) {
            count += popcount(data_32[j] & ldpc_256_128_parity[i][j]);
        }
        coded[16+(i/8)] |= (count % 2) << (7 - (i % 8));
    }
}

/* Each set of four integers is a 128 bit column of the parity block
 * in the LDPC generator matrix.
 */
static const uint32_t ldpc_256_128_parity[128][4] = {
    { 0xE7BC4623, 0x2C48489D, 0x21BD7624, 0xAE57C49E },
    { 0x735EA391, 0x1724A44E, 0x915E3B92, 0xD72B624F },
    { 0x39AFD1C8, 0x0B1252A7, 0x49AF1DC9, 0xEB15B1A7 },
    { 0x9CD768E4, 0x0509A9D3, 0xA5D78EE4, 0xF58AD8D3 },
    { 0xCE6B3472, 0x8284D4E9, 0xD36B47F2, 0x7A45ECE9 },
    { 0xE7351A39, 0x4142EA74, 0xE8B523F9, 0xBD22F674 },
    { 0xF31A8D9C, 0x202175BA, 0xF5DA917C, 0x5E117BBA },
    { 0x798D46CE, 0x91903A5D, 0x7BED48BE, 0xAF883D5D },
    { 0xBD4623E7, 0x49489DAE, 0xBD7624DF, 0x56C49EAE },
    { 0x5FA391F3, 0x24A44ED7, 0x5F3B92EF, 0x2B624F57 },
    { 0xAFD1C8F9, 0x1252A76B, 0xAF1DC9F7, 0x14B1A7AB },
    { 0xD668E4FC, 0x09A9D335, 0xD78EE4FB, 0x8AD8D355 },
    { 0x6B34727E, 0x84D4E99A, 0x6A47F2FD, 0x44ECE92A },
    { 0x341A39BF, 0x42EA744D, 0xB423F97E, 0x23F67415 },
    { 0x1B8D9C5F, 0x2075BA26, 0xDA917C3F, 0x117BBA8A },
    { 0x8D46CEAF, 0x903A5D13, 0xEC48BE1F, 0x883D5DC5 },
    { 0x4723E7D7, 0x489DAE09, 0x7624DF0F, 0xC59EAE62 },
    { 0xA391F3EB, 0xA44ED704, 0x3B92EF07, 0x634F57B1 },
    { 0xD0C8F9F5, 0x53A76B02, 0x1DC9F783, 0xB1A7ABD8 },
    { 0x69E4FC7A, 0xA8D33581, 0x8FE4FBC1, 0xD9D355EC },
    { 0x34727EBD, 0xD4E99A40, 0x47F2FDE0, 0xECE92AF6 },
    { 0x1A39BF5E, 0xEB744D20, 0x23F97EF0, 0xF774157B },
    { 0x8C9C5F2F, 0x74BA2690, 0x917C3FF8, 0x7BBA8ABD },
    { 0x46CEAF17, 0x3B5D1348, 0x48BE1FFC, 0x3C5DC5DE },
    { 0x22E7D70B, 0x9DAE09A4, 0x25DF0F7E, 0x9EAE626F },
    { 0x91F3EB05, 0x4ED704D2, 0x93EF07BF, 0x4F57B137 },
    { 0xC9F9F582, 0xA66B0269, 0xC9F783DF, 0xA7ABD89B },
    { 0xE5FC7AC1, 0xD2358134, 0xE4FBC1EF, 0xD255ECCD },
    { 0x727EBDE0, 0xE89A401A, 0xF3FDE077, 0xE82AF666 },
    { 0x38BF5E70, 0x744D200D, 0xF97EF0BB, 0x75157B33 },
    { 0x9D5F2F38, 0xBA269006, 0x7C3FF8DD, 0xBA8ABD99 },
    { 0xCEAF179C, 0x5D134803, 0xBF1FFC6E, 0x5CC5DE4C },
    { 0xE6D70B4E, 0xAE09A481, 0xDE0F7EB7, 0xAF626F26 },
    { 0xF2EB0527, 0xD704D240, 0xEF07BF5B, 0x57B13793 },
    { 0xF8F58213, 0x6B0269A0, 0xF683DFAD, 0xAAD89BC9 },
    { 0xFC7AC109, 0x358134D0, 0xFAC1EF56, 0x54ECCD64 },
    { 0x7EBDE004, 0x9B401AE8, 0xFDE0772B, 0x2AF66632 },
    { 0xBF5E7002, 0x4C200DF4, 0x7EF0BB95, 0x147B3319 },
    { 0x5E2F3881, 0x2690067A, 0x3FF8DD4A, 0x8ABD990C },
    { 0xAE179C40, 0x1348033D, 0x1FFC6EA5, 0xC5DE4C06 },
    { 0xD60B4E20, 0x09A4819E, 0x0F7EB7D2, 0x636F2683 },
    { 0xEB052710, 0x04D240CF, 0x07BF5BE9, 0xB03793C1 },
    { 0xF4821388, 0x0369A067, 0x83DFADF4, 0xD89BC960 },
    { 0x7AC10944, 0x8034D0B3, 0xC1EF56FA, 0xEDCD6430 },
    { 0xBCE00422, 0x401AE859, 0xE1772BFD, 0xF6663298 },
    { 0x5E700211, 0x210DF42C, 0xF1BB95FE, 0x7B33194C },
    { 0x2E388108, 0x90067A96, 0xF9DD4AFF, 0xBD990CA6 },
    { 0x179C4004, 0x48033D4B, 0xFC6EA5FF, 0xDE4C06D3 },
    { 0x0B4E2082, 0xA5819E25, 0x7FB7D27F, 0x6E268369 },
    { 0x042710C1, 0xD240CF92, 0xBE5BE9BF, 0x3793C134 },
    { 0x82138860, 0x68A06749, 0xDEADF45F, 0x9BC9609A },
    { 0xC1094430, 0x34D0B324, 0xEF56FA2F, 0xCC6430CD },
    { 0xE1042298, 0x1AE85912, 0x772BFD97, 0x66329866 },
    { 0x710211CC, 0x0DF42C09, 0xBA95FECB, 0x32194C33 },
    { 0x388108E6, 0x077A9684, 0xDC4AFF65, 0x990CA619 },
    { 0x9C400473, 0x023D4BC2, 0x6EA5FF32, 0x4D06D38C },
    { 0x4F208239, 0x819E2561, 0xB6D27F19, 0x278369C6 },
    { 0x2610C19C, 0x41CF92B0, 0x5BE9BF0C, 0x92C134E3 },
    { 0x1388604E, 0xA16749D8, 0xADF45F86, 0xC8609A71 },
    { 0x084430A7, 0xD1B324EC, 0x57FA2FC3, 0x6430CD38 },
    { 0x04229853, 0xE85912F6, 0x2AFD97E1, 0x3398661C },
    { 0x0211CC29, 0xF42C097B, 0x94FECB70, 0x184C338E },
    { 0x8108E614, 0x7B96843D, 0x4AFF6538, 0x0DA61947 },
    { 0x4004738A, 0x3C4BC29E, 0xA5FF321C, 0x07D38CA3 },
    { 0x20823945, 0x9F25614F, 0xD27F198E, 0x8369C6D1 },
    { 0x11C19C22, 0xCE92B0A7, 0xE8BF0C47, 0xC034E3E8 },
    { 0x89604E91, 0x6649D853, 0xF45F8623, 0x619A7174 },
    { 0x4430A7C8, 0xB224EC29, 0xFB2FC311, 0x30CD38BA },
    { 0x23985364, 0x5912F614, 0xFD97E188, 0x98661C5D },
    { 0x11CC29B2, 0x2D097B8A, 0xFFCB70C4, 0x4C338E2E },
    { 0x08E614D9, 0x97843DC5, 0xFE6538E2, 0xA6194717 },
    { 0x05738A6C, 0x4BC29EE2, 0xFE321C71, 0xD38CA30B },
    { 0x833945B6, 0x24614FF1, 0x7F198E38, 0x69C6D185 },
    { 0xC19C22DB, 0x92B0A778, 0xBF0C479C, 0x35E3E8C2 },
    { 0x604E91ED, 0x48D8533C, 0x5E8623CE, 0x9B7174E1 },
    { 0x31A7C876, 0x24EC291E, 0x2FC31167, 0xCC38BAF0 },
    { 0x995364BB, 0x13F6140F, 0x97E188B3, 0x671C5D78 },
    { 0xCC29B2DD, 0x097B8A87, 0xCA70C4D9, 0x338E2EBC },
    { 0xE714D96E, 0x843DC5C3, 0x6438E26C, 0x184717DE },
    { 0x728A6CB7, 0xC39EE261, 0x321C7136, 0x8CA30B6F },
    { 0x3945B65B, 0x614FF1B0, 0x188E381B, 0xC7D18537 },
    { 0x9D22DBAD, 0xB0A778D8, 0x0C479C0D, 0xE3E8C29B },
    { 0x4E91EDD6, 0xD9533C6C, 0x8623CE06, 0x7074E1CD },
    { 0xA7C8766B, 0xED291EB6, 0xC3116703, 0x39BAF066 },
    { 0x5264BBB5, 0xF6140FDB, 0xE188B381, 0x1C5D78B3 },
    { 0x28B2DD5A, 0x7A8A876D, 0x70C4D9C0, 0x8F2EBC59 },
    { 0x14D96E2D, 0x3DC5C336, 0x39E26C60, 0x4617DEAC },
    { 0x8B6CB716, 0x9EE2619B, 0x1C7136B0, 0xA20B6F56 },
    { 0x45B65B8B, 0x4EF1B04D, 0x8F381B58, 0xD085372B },
    { 0x23DBADC5, 0xA778D826, 0x469C0DAC, 0xE9C29B15 },
    { 0x90EDD6E2, 0x523C6C93, 0x22CE0656, 0x75E1CD8A },
    { 0xC9766B71, 0x291EB649, 0x1167032B, 0xBAF066C5 },
    { 0x64BBB5B8, 0x140FDBA4, 0x89B38195, 0x5C78B362 },
    { 0xB2DD5A5C, 0x8A876D52, 0xC5D9C0CA, 0x2EBC5931 },
    { 0xD96E2D2E, 0xC4C33629, 0xE26C60E5, 0x17DEAC18 },
    { 0x6DB71697, 0xE2619B14, 0x7036B072, 0x0B6F568C },
    { 0xB75B8BCB, 0xF1B04D0A, 0x381B5839, 0x85372BC6 },
    { 0xDBADC5E5, 0x78D82685, 0x9C0DAC1C, 0xC39B15E3 },
    { 0xEDD6E2F2, 0x3D6C9342, 0xCE06560E, 0xE1CD8AF1 },
    { 0x766B71F9, 0x1FB649A1, 0x66032B07, 0xF166C5F8 },
    { 0xBAB5B87C, 0x0EDBA4D0, 0xB2819503, 0x78B362FC },
    { 0xDD5A5C3E, 0x876D5268, 0xD9C0CA01, 0xBD59317E },
    { 0x6F2D2E9F, 0xC23629B4, 0x6C60E580, 0xDEAC18BF },
    { 0xB71697CF, 0x609B145A, 0x36B07240, 0x6F568C5F },
    { 0x5A8BCBE7, 0xB04D0A2D, 0x1B583920, 0x372BC6AF },
    { 0xACC5E573, 0xD8268516, 0x0CAC1C90, 0x9B15E3D7 },
    { 0xD7E2F239, 0x6C93420B, 0x07560E48, 0xCD8AF1EB },
    { 0x6B71F99C, 0xB749A105, 0x032B07A4, 0x66C5F8F5 },
    { 0xB5B87CCE, 0xDAA4D082, 0x819503D2, 0xB362FC7A },
    { 0x5B5C3EE7, 0x6C526841, 0xC1CA01E9, 0x58317EBD },
    { 0x2C2E9FF3, 0x3729B420, 0x60E580F4, 0xAD18BF5E },
    { 0x1797CF79, 0x9A145A90, 0xB172407A, 0x568C5FAF },
    { 0x8ACBE7BC, 0x4C0A2D48, 0x583920BD, 0x2AC6AF57 },
    { 0xC5E5735E, 0x26851624, 0xAD1C905E, 0x14E3D72B },
    { 0xE3F239AF, 0x92420B12, 0x570E48AF, 0x8BF1EB15 },
    { 0x70F99CD7, 0x49A10509, 0x2A07A4D7, 0xC4F8F58A },
    { 0xB87CCE6B, 0xA4D08284, 0x9503D26B, 0x62FC7A45 },
    { 0x5C3EE735, 0x52684142, 0xCB01E9B5, 0x307EBD22 },
    { 0x2F9FF31A, 0x29B42021, 0xE580F4DA, 0x19BF5E11 },
    { 0x96CF798D, 0x145A9090, 0x72407AED, 0x8D5FAF88 },
    { 0xCBE7BC46, 0x0B2D4848, 0x3820BD76, 0xC6AF57C4 },
    { 0xE5735EA3, 0x841624A4, 0x1C905E3B, 0xE3D72B62 },
    { 0xF239AFD1, 0x430B1252, 0x0F48AF1D, 0xF1EB15B1 },
    { 0xF89CD768, 0xA10509A9, 0x06A4D78E, 0xF9F58AD8 },
    { 0x7CCE6B34, 0xD18284D4, 0x02D26B47, 0xFD7A45EC },
    { 0x3FE7351A, 0x684142EA, 0x01E9B523, 0x7EBD22F6 },
    { 0x9EF31A8D, 0xB4202175, 0x80F4DA91, 0xBE5E117B },
    { 0xCE798D46, 0x5B90903A, 0x407AED48, 0x5FAF883D },
};
